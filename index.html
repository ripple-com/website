<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Draughts Scanner Pro</title>
    <style>
        body { background: #121212; color: white; font-family: sans-serif; text-align: center; padding: 20px; }
        .wrapper { max-width: 500px; margin: auto; }
        #view-area { position: relative; width: 100%; aspect-ratio: 1/1; background: #000; border-radius: 12px; border: 3px solid #2ecc71; overflow: hidden; }
        video { width: 100%; height: 100%; object-fit: cover; }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .btn-scan { background: #e67e22; color: white; padding: 15px; border: none; border-radius: 8px; width: 100%; font-size: 18px; cursor: pointer; margin-top: 15px; }
        #log-panel { margin-top: 20px; padding: 15px; background: #1e1e1e; border-radius: 10px; }
        .move-display { font-size: 35px; color: #f1c40f; font-weight: bold; }
    </style>
</head>
<body>

<div class="wrapper">
    <h2>AI සජීවී දාම් ස්කෑනර්</h2>
    
    <div id="view-area">
        <video id="webcam" autoplay playsinline></video>
        <canvas id="overlay"></canvas>
    </div>

    <button class="btn-scan" onclick="runAnalysis()">හොඳම ඇදීම සොයන්න</button>

    <div id="log-panel">
        <div id="status">තත්ත්වය: සූදානම්</div>
        <div id="best-move" class="move-display">---</div>
    </div>
</div>

<script>
    const video = document.getElementById('webcam');
    const canvas = document.getElementById('overlay');
    const ctx = canvas.getContext('2d');
    const statusEl = document.getElementById('status');
    const moveEl = document.getElementById('best-move');

    // කැමරාව පණගැන්වීම
    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
        .then(stream => {
            video.srcObject = stream;
            video.addEventListener('loadedmetadata', () => {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                drawGrid();
            });
        })
        .catch(err => statusEl.innerText = "කැමරා දෝෂයකි!");

    function drawGrid() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.strokeStyle = "rgba(46, 204, 113, 0.5)";
        const size = canvas.width / 10;
        for(let i=0; i<=10; i++) {
            ctx.moveTo(i*size, 0); ctx.lineTo(i*size, canvas.height);
            ctx.moveTo(0, i*size); ctx.lineTo(canvas.width, i*size);
        }
        ctx.stroke();
        requestAnimationFrame(drawGrid);
    }

    async function runAnalysis() {
        statusEl.innerText = "දත්ත ලබා ගනිමින්...";
        // ආරම්භක අවස්ථාව සඳහා FEN එක
        const fen = "W:W31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50:B1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20";
        
        // විකල්ප Proxy එකක් - Corsproxy.io
        const url = `https://corsproxy.io/?${encodeURIComponent('https://lidraughts.org/api/cloud-eval?fen=' + fen + '&variant=international')}`;

        try {
            const res = await fetch(url);
            if (!res.ok) throw new Error("API කාර්යබහුලයි");
            const data = await res.json();

            if (data.pvs && data.pvs[0]) {
                moveEl.innerText = data.pvs[0].moves.split(' ')[0];
                statusEl.innerText = "සාර්ථකයි!";
            } else {
                statusEl.innerText = "දත්ත හමු නොවීය.";
            }
        } catch (err) {
            statusEl.innerText = "සම්බන්ධතා දෝෂයකි. නැවත උත්සාහ කරන්න.";
            console.error(err);
        }
    }
</script>
</body>
</html>
