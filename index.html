<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <title>AI 10x10 Draughts Scanner Pro</title>
    <script async src="https://docs.opencv.org/4.5.4/opencv.js" type="text/javascript"></script>
    <style>
        body { background: #121212; color: white; font-family: sans-serif; text-align: center; }
        .container { max-width: 600px; margin: auto; padding: 20px; }
        #video-container { position: relative; border: 4px solid #333; border-radius: 10px; overflow: hidden; background: #000; }
        video { width: 100%; height: auto; display: block; }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .controls { margin: 20px 0; display: flex; gap: 10px; justify-content: center; }
        button { padding: 15px 25px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-start { background: #2ecc71; color: white; }
        .btn-scan { background: #3498db; color: white; }
        #result-box { background: #1e1e1e; padding: 15px; border-radius: 10px; border-left: 5px solid #f1c40f; }
        .move-text { font-size: 24px; color: #f1c40f; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h2>AI සජීවී දාම් ස්කෑනර් (10x10)</h2>
    
    <div id="video-container">
        <video id="webcam" autoplay playsinline></video>
        <canvas id="overlay"></canvas>
    </div>

    <div class="controls">
        <button class="btn-start" onclick="initWebcam()">කැමරාව පණගන්වන්න</button>
        <button class="btn-scan" onclick="analyzeFrame()">දැන් පරීක්ෂා කරන්න</button>
    </div>

    <div id="result-box">
        <div>තත්ත්වය: <span id="status">සූදානම්</span></div>
        <div class="move-text" id="best-move">---</div>
    </div>
</div>

<script>
    const video = document.getElementById('webcam');
    const canvas = document.getElementById('overlay');
    const ctx = canvas.getContext('2d');
    const statusTxt = document.getElementById('status');
    const moveTxt = document.getElementById('best-move');

    // 1. කැමරාව සැකසීම
    async function initWebcam() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment", width: 1280, height: 720 } 
            });
            video.srcObject = stream;
            statusTxt.innerText = "කැමරාව ක්‍රියාත්මකයි";
            requestAnimationFrame(processVideo);
        } catch (err) {
            alert("කැමරාවට අවසර දෙන්න (HTTPS අවශ්‍යයි)");
        }
    }

    // 2. සජීවීව බෝඩ් එක මත Grid එක ඇඳීම
    function processVideo() {
        if (video.paused || video.ended) return;
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawBoardGrid();
        requestAnimationFrame(processVideo);
    }

    function drawBoardGrid() {
        ctx.strokeStyle = "rgba(46, 204, 113, 0.4)";
        ctx.lineWidth = 2;
        const w = canvas.width;
        const h = canvas.height;

        for (let i = 0; i <= 10; i++) {
            ctx.beginPath();
            ctx.moveTo(i * (w/10), 0); ctx.lineTo(i * (w/10), h); ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(0, i * (h/10)); ctx.lineTo(w, i * (h/10)); ctx.stroke();
        }
    }

    // 3. රූපය විශ්ලේෂණය කර හොඳම ඇදීම සෙවීම
    async function analyzeFrame() {
        statusTxt.innerText = "ඉත්තන් හඳුනාගනිමින්...";
        
        // මෙතැනදී OpenCV මගින් පික්සල් පරීක්ෂා කර FEN String එකක් සාදයි
        // දැනට පරීක්ෂණය සඳහා මම sample FEN එකක් භාවිතා කරමි
        // සැබෑ ක්‍රීඩාවකදී මෙය ඉත්තන් සිටින තැන් අනුව වෙනස් විය යුතුය
        const sampleFEN = "W:W31-50:B1-20"; 

        try {
            const response = await fetch(`https://lidraughts.org/api/cloud-eval?fen=${sampleFEN}&variant=international`);
            const data = await response.json();
            
            if (data.pvs && data.pvs[0]) {
                const bestMove = data.pvs[0].moves.split(' ')[0];
                moveTxt.innerText = "හොඳම ඇදීම: " + bestMove;
                statusTxt.innerText = "සාර්ථකයි!";
            } else {
                moveTxt.innerText = "ඇදීමක් හමු නොවීය";
            }
        } catch (e) {
            statusTxt.innerText = "API සම්බන්ධතාවයේ දෝෂයකි";
        }
    }
</script>

</body>
</html>
