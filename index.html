<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Live Draughts Scanner 10x10</title>
    <script async src="https://docs.opencv.org/4.5.4/opencv.js" type="text/javascript"></script>
    <style>
        body { background: #121212; color: white; font-family: 'Segoe UI', sans-serif; text-align: center; margin: 0; padding: 20px; }
        .wrapper { max-width: 600px; margin: auto; }
        h2 { color: #2ecc71; margin-bottom: 10px; }
        #view-area { position: relative; width: 100%; aspect-ratio: 1/1; background: #000; border: 4px solid #333; border-radius: 12px; overflow: hidden; }
        video { width: 100%; height: 100%; object-fit: cover; }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .controls { margin-top: 20px; display: flex; flex-direction: column; gap: 10px; }
        button { padding: 15px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-cam { background: #3498db; color: white; }
        .btn-scan { background: #e67e22; color: white; }
        #log-panel { margin-top: 20px; padding: 15px; background: #1e1e1e; border-radius: 10px; border-bottom: 4px solid #2ecc71; }
        .move-display { font-size: 28px; color: #f1c40f; font-weight: bold; margin-top: 5px; }
    </style>
</head>
<body>

<div class="wrapper">
    <h2>AI සජීවී දාම් ස්කෑනර්</h2>
    
    <div id="view-area">
        <video id="webcam" autoplay playsinline></video>
        <canvas id="overlay"></canvas>
    </div>

    <div class="controls">
        <button class="btn-cam" onclick="startCamera()">1. කැමරාව පණගන්වන්න</button>
        <button class="btn-scan" onclick="runAnalysis()">2. ඉත්තා අදින තැන බලන්න</button>
    </div>

    <div id="log-panel">
        <div id="status">තත්ත්වය: සූදානම්</div>
        <div id="best-move" class="move-display">---</div>
    </div>
</div>

<script>
    const video = document.getElementById('webcam');
    const canvas = document.getElementById('overlay');
    const ctx = canvas.getContext('2d');
    const statusEl = document.getElementById('status');
    const moveEl = document.getElementById('best-move');

    // කැමරාව පණගැන්වීම
    async function startCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment", width: { ideal: 1080 }, height: { ideal: 1080 } } 
            });
            video.srcObject = stream;
            statusEl.innerText = "කැමරාව සක්‍රියයි. බෝඩ් එක මැදි කරන්න.";
            drawGridLoop();
        } catch (err) {
            statusEl.innerText = "කැමරා දෝෂයකි. HTTPS පරීක්ෂා කරන්න.";
        }
    }

    // බෝඩ් එක මත 10x10 කොටු ඇඳීම
    function drawGridLoop() {
        if (video.paused || video.ended) return;
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.strokeStyle = "rgba(46, 204, 113, 0.5)";
        ctx.lineWidth = 2;

        const cellSize = canvas.width / 10;
        for (let i = 0; i <= 10; i++) {
            ctx.beginPath();
            ctx.moveTo(i * cellSize, 0); ctx.lineTo(i * cellSize, canvas.height); ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(0, i * cellSize); ctx.lineTo(canvas.width, i * cellSize); ctx.stroke();
        }
        requestAnimationFrame(drawGridLoop);
    }

    // විශ්ලේෂණය සහ API සම්බන්ධතාවය
    async function runAnalysis() {
        statusEl.innerText = "විශ්ලේෂණය කරමින්...";
        moveEl.innerText = "සොයමින්...";

        // සාම්පල FEN (ඔබේ බෝඩ් එකේ පවතින තත්ත්වය අනුව මෙය ස්වයංක්‍රීයව වෙනස් විය යුතුය)
        // W = සුදු වාරය, W31-50 = සුදු ඉත්තන්, B1-20 = කළු ඉත්තන්
        const fen = "W:W31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50:B1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20";

        try {
            // CORS ගැටලුව මඟහැරීමට Lidraughts Cloud API භාවිතා කිරීම
            const response = await fetch(`https://lidraughts.org/api/cloud-eval?fen=${fen}&variant=international`);
            
            if (!response.ok) throw new Error("API දෝෂයකි");
            
            const data = await response.json();
            
            if (data.pvs && data.pvs[0]) {
                const bestMove = data.pvs[0].moves.split(' ')[0];
                moveEl.innerText = bestMove;
                statusEl.innerText = "හොඳම ඇදීම සොයාගත්තා!";
                highlightMove(bestMove);
            } else {
                statusEl.innerText = "ඇදීම් හමු නොවීය.";
            }
        } catch (error) {
            statusEl.innerText = "සම්බන්ධතා දෝෂයකි. (CORS හෝ Network)";
            console.error(error);
        }
    }

    function highlightMove(move) {
        // ඇදීම බෝඩ් එක මත ඊතලයකින් පෙන්වීමට මෙතැනට Code එක් කළ හැකිය
        console.log("Move to play: " + move);
    }
</script>

</body>
</html>
